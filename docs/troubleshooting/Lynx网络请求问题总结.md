# Lynx 网络请求问题总结

## 🎯 问题回顾

在 Lynx 环境中测试代理配置时，遇到了一系列问题，最终找到了完整的解决方案。

## 📌 问题1: 相对路径请求失败

### 错误信息
```
HTTP 499: unsupported URL
```

### 原因
在 Lynx 环境中，直接使用相对路径（如 `/api/shops`）发起请求会失败。

```typescript
// ❌ 在 Lynx 中不工作
fetch('/api/shops')
```

### 为什么？
- Lynx 是移动端跨端渲染框架
- 运行在特殊的 JavaScript 引擎中
- 对网络请求有严格的限制
- 不支持相对路径的网络请求

## 📌 问题2: localhost 无法访问

### 错误信息
```
HTTP 499: Could not connect to the server
```

### 尝试的方案
```typescript
// ❌ 在 Lynx 中也不工作
fetch('http://localhost:4000/api/shops')
```

### 原因
Lynx 环境类似于真实的移动设备：
- `localhost` 指向的是设备本身（手机/模拟器）
- 无法通过 `localhost` 访问开发机器上的服务器
- 就像手机无法通过 `localhost` 访问电脑一样

### 类比理解
```
┌─────────────┐          ┌─────────────┐
│  手机设备    │          │  开发电脑    │
│             │          │             │
│ localhost   │    ✗     │ localhost   │
│ (手机自己)  │ ────────>│ (电脑服务器)│
└─────────────┘          └─────────────┘

需要使用电脑的局域网 IP：

┌─────────────┐          ┌─────────────┐
│  手机设备    │          │  开发电脑    │
│             │          │             │
│             │    ✓     │192.168.0.100│
│             │ ────────>│   :4000     │
└─────────────┘          └─────────────┘
```

## 📌 问题3: 静态资源无法加载

### 现象
后端返回的图片路径 `/static/image/default-cover.png` 在 Lynx 中无法显示

### 原因
- 后端返回的是前端静态资源的相对路径
- 在 Lynx 中，相对路径无法正确解析
- 需要完整的 URL 才能访问

### 解决方案
将相对路径转换为完整 URL：
```typescript
// 后端返回
"/static/image/default-cover.png"

// Lynx 环境需要
"http://192.168.0.100:3001/static/image/default-cover.png"
```

## ✅ 完整解决方案

### 1. HTTP 请求封装 (`utils/http.ts`)

```typescript
function getBaseURL(): string {
  if (import.meta.env.DEV) {
    const isLynx = typeof __MAIN_THREAD__ !== 'undefined'
    
    if (isLynx) {
      // ✅ Lynx: 使用局域网 IP
      return 'http://192.168.0.100:4000'
    } else {
      // ✅ 浏览器: 使用相对路径 + 代理
      return ''
    }
  }
  
  return import.meta.env.VITE_API_BASE_URL || ''
}
```

**关键点**：
- 检测 Lynx 环境：`typeof __MAIN_THREAD__ !== 'undefined'`
- Lynx 中使用完整 URL + 真实 IP
- 浏览器中使用相对路径（通过代理）

### 2. 后端服务器配置 (`mock/server.cjs`)

```javascript
// ✅ 监听所有网络接口
app.listen(4000, '0.0.0.0', () => {
  console.log('Mock API 运行在 http://localhost:4000')
  console.log('局域网访问: http://192.168.0.100:4000')
})
```

**关键点**：
- 监听 `0.0.0.0` 而不是默认的 `localhost`
- 允许从局域网其他设备访问

### 3. 图片路径处理 (`pages/restaurant/index.tsx`)

```typescript
function processImageUrl(url: string): string {
  if (url.startsWith('/static/')) {
    const isLynx = typeof __MAIN_THREAD__ !== 'undefined'
    if (isLynx) {
      // ✅ Lynx: 转换为完整 URL
      return `http://192.168.0.100:3001${url}`
    }
    return url
  }
  return url
}
```

**关键点**：
- 检测静态资源路径
- Lynx 中转换为完整 URL（前端服务器地址）
- 浏览器中保持原样

## 🤔 为什么会这样？

### Lynx 的本质

Lynx 不是传统的 Web 环境，而是：

1. **移动端渲染引擎**
   - 类似于 React Native、Flutter
   - 运行在客户端（手机/模拟器）
   - 不是浏览器环境

2. **网络隔离**
   - 客户端设备有独立的网络栈
   - `localhost` 指向设备自己
   - 需要通过 IP 地址访问开发机器

3. **资源访问限制**
   - 不支持相对路径的网络请求
   - 需要完整的 URL（协议 + 域名/IP + 端口 + 路径）
   - 安全性考虑，避免不明确的请求

### 与传统 Web 的对比

| 特性 | 传统浏览器 Web | Lynx 环境 |
|------|---------------|-----------|
| 环境 | 浏览器 | 移动端客户端 |
| localhost | 指向本机 | 指向设备自己 |
| 相对路径请求 | ✅ 支持 | ❌ 不支持 |
| 代理配置 | ✅ 有效 | ❌ 无效（在客户端） |
| 跨域 | 同源策略限制 | 不同的限制机制 |

## 💡 核心理解

### 问题的根本原因

**Lynx 环境 ≠ 浏览器环境**

```
浏览器环境:
┌──────────────────────────────┐
│  浏览器                       │
│  ├─ 前端代码 (同一进程)       │
│  ├─ 代理功能 (开发服务器)     │
│  └─ 相对路径可用              │
└──────────────────────────────┘

Lynx 环境:
┌──────────────┐    网络    ┌──────────────┐
│  移动设备     │  ────────> │  开发电脑     │
│  ├─ Lynx引擎  │            │  ├─ 后端:4000 │
│  └─ 前端代码  │            │  └─ 前端:3001 │
└──────────────┘            └──────────────┘
  (独立设备)                   (另一台设备)
```

### 关键认知

1. **代理配置在 Lynx 中不起作用**
   - 代理是前端开发服务器的功能
   - Lynx 运行在客户端，不经过开发服务器
   - 需要直接访问后端服务器

2. **必须使用完整 URL**
   - 协议：`http://` 或 `https://`
   - 地址：真实的 IP（不能是 localhost）
   - 端口：明确指定
   - 路径：完整的资源路径

3. **环境检测至关重要**
   - 通过 `typeof __MAIN_THREAD__` 判断是否在 Lynx 中
   - 不同环境使用不同的请求策略
   - 保证代码在两种环境中都能工作

## 🎯 最佳实践

### 开发流程

1. **环境检测函数**
   ```typescript
   const isLynx = typeof __MAIN_THREAD__ !== 'undefined'
   ```

2. **API 请求**
   ```typescript
   // Lynx: http://192.168.0.100:4000/api/xxx
   // 浏览器: /api/xxx (通过代理)
   ```

3. **静态资源**
   ```typescript
   // Lynx: http://192.168.0.100:3001/static/xxx
   // 浏览器: /static/xxx
   ```

### IP 地址配置

**当前方案的局限性**：
- IP 地址硬编码在代码中
- 如果 IP 变化需要手动修改

**改进方案**（可选）：
1. 使用环境变量
2. 自动检测本机 IP
3. 配置文件管理

## 📚 学到的经验

### 1. 跨端框架的特殊性
- 不能用 Web 思维理解跨端框架
- 网络请求有不同的限制
- 需要深入理解框架特性

### 2. 环境差异处理
- 开发时要考虑多种运行环境
- 通过环境检测提供不同实现
- 统一的 API 接口，内部处理差异

### 3. 调试方法
- 查看详细的错误信息
- 理解错误背后的原因
- 逐步排查，找到根本问题

### 4. 文档重要性
- 框架文档可能没有覆盖所有场景
- 需要通过实践理解框架限制
- 记录问题和解决方案供他人参考

## 🎉 总结

### 问题本质
Lynx 是移动端渲染框架，不是浏览器环境，有独立的网络栈和限制。

### 解决核心
1. 环境检测（Lynx vs 浏览器）
2. Lynx 中使用完整 URL + 真实 IP
3. 浏览器中使用相对路径 + 代理

### 最终方案
- ✅ HTTP 请求封装自动适配环境
- ✅ 后端监听所有网络接口
- ✅ 图片路径自动转换
- ✅ 两种环境都能正常工作

这个问题的解决过程展示了跨端开发的复杂性，以及理解底层原理的重要性！

